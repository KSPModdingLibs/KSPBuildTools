<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Condition=" '$(KSPCommonPropsImported)' == '' " Project="KSPCommon.props"/>

  <!-- Pre/post build targets -->
  <Target Name="BeforeBuildScript" BeforeTargets="Build">
  </Target>
  <Target Name="PostBuildScript" AfterTargets="Build">
    <CallTarget Targets="CopyBinariesToRepo"/>
  </Target>

  <!--Custom Targets-->

  <!-- this probably isn't the best way to do this, because it doesn't necessarily get run when switching build configs (debug/release)-->
  <!-- make sure to always do a rebuild when switching configs and you should be fine -->
  <Target Name="CopyBinariesToRepo">
    <ItemGroup>
      <BinariesToCopy Include="$(TargetDir)\*.*"/>
    </ItemGroup>
    <Copy SourceFiles="@(BinariesToCopy)" DestinationFolder="$(RepoRootPath)\$(BinariesOutputRelativePath)"/>
  </Target>

  <!-- Use CKAN to install mods for any references tagged with a CKAN Identifier -->
  <Target Name="CKANInstall" BeforeTargets="_GenerateRestoreProjectSpec;Restore">
    <ItemGroup>
      <_CKANCompatibleVersionItems Include="$(CKANCompatibleVersions.Split(' '))"/>
      <_CKANDependency Include="%(Reference.CKANIdentifier)"/>
      <_CKANDependency Include="@(CKANDependency)"/>
    </ItemGroup>

    <PropertyGroup>
      <_TempStagingFolder>$([System.IO.Path]::Combine($([System.IO.Path]::GetTempPath()), $([System.IO.Path]::GetRandomFileName())))</_TempStagingFolder>
      <_CKANCommandFile>$(_TempStagingFolder)/ckan_commands.txt</_CKANCommandFile>
      <_CKANDependencyList>@(_CKANDependency, ' ')</_CKANDependencyList>
    </PropertyGroup>

    <ItemGroup>
      <!-- Not using `ckan compat set` because as of 2024-08-16 it is still only available in the dev branch -->
      <_CKANCommands Include="compat add --gamedir &quot;$(KSPROOT)&quot; %(_CKANCompatibleVersionItems.Identity)"
                    Condition=" '$(CKANCompatibleVersions)' != '' "/>

      <_CKANCommands Include="install --no-recommends --gamedir &quot;$(KSPROOT)&quot; $(_CKANDependencyList)"/>
    </ItemGroup>

    <Message Text="Writing CKAN commands to $(_CKANCommandFile)"/>
    <Message Text="@(_CKANCommands, '%0a')" Importance="Low"/>
    <WriteLinesToFile File="$(_CKANCommandFile)" Lines="@(_CKANCommands)"/>
    <Exec Command="cat '$(_CKANCommandFile)' | ckan prompt --headless"
          Condition="'$(_CKANDependencyList)' != ''"/>
    <RemoveDir Directories="$(_TempStagingFolder)"/>
  </Target>

  <!--  For use like so: `msbuild -t:"GetRequiredExternalTools" -verbosity:minimal -nologo`, then pipe into your destination of choice -->
  <Target Name="GetRequiredExternalTools">
    <ItemGroup>
      <CKANDependencyList Include="%(Reference.CKANIdentifier)"/>
      <RequiredExternalTool Include="CKAN" Condition="@(CKANDependencyList) != ''"/>
    </ItemGroup>
    <Message Text="@(RequiredExternalTool)" Importance="high"/>
  </Target>

  <!--
  Gets version info from Git, or falls back to 0.0.0 if this fails.
  This will not work if you have any hyphens in your tag names. blame Git

  Populates the following properties:
    GitTag: The most recent tag in the repo
    GitHeight: The number of commits since that tag
    GitCommit: The most recent git commit hash in the repo
    VersionMajor: The major SemVer version number. Taken directly from the tag
    VersionMinor: The minor SemVer version number. Taken directly from the tag
    VersionPatch: The patch SemVer version number. Taken from the tag, and incremented by 1 if GitHeight != 0
    Version: (MSBuild wellknown property) The calculated version
    Build: The build number. Equal to GitHeight
  -->
  <Target Name="GetVersionFromGit" BeforeTargets="BeforeBuild" Condition="$(PopulateVersionFromGit)">
    <Exec Command="git describe --tags --long" ConsoleToMSBuild="true"
          IgnoreStandardErrorWarningFormat="true" IgnoreExitCode="true"
          EchoOff="true" WorkingDirectory="$(RepoRootPath)">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitDescribe"/>
      <Output TaskParameter="ExitCode" PropertyName="_GitDescribeExit"/>
    </Exec>
    <PropertyGroup Condition="$(_GitDescribeExit) == 0">
      <GitTag>$(_GitDescribe.Split('-')[0])</GitTag>
      <GitHeight>$(_GitDescribe.Split('-')[1])</GitHeight>
      <GitCommit>$(_GitDescribe.Split('-')[2])</GitCommit>
      <VersionMajor>$(GitTag.Split('.')[0])</VersionMajor>
      <VersionMinor>$(GitTag.Split('.')[1])</VersionMinor>
      <VersionPatch>$(GitTag.Split('.')[2])</VersionPatch>
      <VersionPatch Condition="$(GitHeight) != '0'">$([MSBuild]::Add($(VersionPatch), 1))</VersionPatch>
      <Build>$(GitHeight)</Build>
    </PropertyGroup>
    <PropertyGroup Condition="$(_GitDescribeExit) != 0">
      <!-- Git describe failed, so fallback to a backup version-->
      <VersionMajor>0</VersionMajor>
      <VersionMinor>0</VersionMinor>
      <VersionPatch>0</VersionPatch>
      <Build>0</Build>
    </PropertyGroup>
    <PropertyGroup>
      <Version>$(VersionMajor).$(VersionMinor).$(VersionPatch)</Version>
    </PropertyGroup>
    <Message Text="Calculated version from git is $(Version)" Condition="$(_GitDescribeExit) == 0"/>
  </Target>


</Project>
